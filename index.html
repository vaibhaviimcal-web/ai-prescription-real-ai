<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prescription - Multi-AI Ready!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-2 rounded-lg">
                        <i class="fas fa-file-medical text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                            AI Prescription Pro
                        </h1>
                        <p class="text-sm text-gray-600">âœ… Multi-AI Ready â€¢ 4 AI Models â€¢ LocalStorage DB</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showHistory()" class="px-4 py-2 text-gray-700 hover:text-indigo-600 transition">
                        <i class="fas fa-history mr-2"></i>History (<span id="historyCount">0</span>)
                    </button>
                    <div class="px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold">
                        <i class="fas fa-check-circle mr-2"></i>AI Connected
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Success Banner -->
    <div class="bg-green-50 border-b border-green-200 py-3">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-center space-x-3">
                <i class="fas fa-check-circle text-green-600 text-xl"></i>
                <p class="text-sm text-green-800 font-semibold">
                    âœ… OpenRouter AI Connected! Choose from GPT-4, Gemini, Claude, or Llama - All Ready!
                </p>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-indigo-100 hover:shadow-xl transition">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Total Prescriptions</p>
                        <p class="text-3xl font-bold text-indigo-600" id="totalPrescriptions">0</p>
                    </div>
                    <div class="bg-indigo-100 p-4 rounded-full">
                        <i class="fas fa-file-prescription text-indigo-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-green-100 hover:shadow-xl transition">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Patients</p>
                        <p class="text-3xl font-bold text-green-600" id="totalPatients">0</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-full">
                        <i class="fas fa-users text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-purple-100 hover:shadow-xl transition">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">AI Models</p>
                        <p class="text-2xl font-bold text-purple-600">4 Available</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-full">
                        <i class="fas fa-robot text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-lg border border-green-100 hover:shadow-xl transition">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600 mb-1">Status</p>
                        <p class="text-lg font-bold text-green-600">Connected âœ“</p>
                    </div>
                    <div class="bg-green-100 p-4 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generator -->
        <div class="grid md:grid-cols-2 gap-8">
            <!-- Form -->
            <div class="bg-white rounded-xl shadow-xl p-8 border border-gray-100">
                <div class="flex items-center space-x-3 mb-6">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-3 rounded-lg">
                        <i class="fas fa-magic text-white text-xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">Generate Prescription</h2>
                </div>

                <form id="prescriptionForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-user mr-2 text-indigo-600"></i>Patient Name
                        </label>
                        <input type="text" id="patientName" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                            placeholder="Enter patient name" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-birthday-cake mr-2 text-indigo-600"></i>Age
                            </label>
                            <input type="number" id="patientAge" 
                                class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                                placeholder="Age" required>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                <i class="fas fa-venus-mars mr-2 text-indigo-600"></i>Gender
                            </label>
                            <select id="gender" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                                <option>Male</option>
                                <option>Female</option>
                                <option>Other</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-stethoscope mr-2 text-indigo-600"></i>Symptoms & Diagnosis
                        </label>
                        <textarea id="symptoms" rows="5" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
                            placeholder="Describe symptoms in detail (e.g., fever since 2 days, dry cough, headache, body ache)..." required></textarea>
                        <p class="text-xs text-gray-500 mt-1">ðŸ’¡ Be specific for better AI analysis</p>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-robot mr-2 text-indigo-600"></i>AI Model
                        </label>
                        <select id="aiModel" class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition">
                            <option value="openai/gpt-4-turbo">ðŸ¤– OpenAI GPT-4 Turbo (Best Quality)</option>
                            <option value="google/gemini-pro-1.5">âœ¨ Google Gemini Pro 1.5 (Fast)</option>
                            <option value="anthropic/claude-3-sonnet">ðŸ§  Claude 3 Sonnet (Detailed)</option>
                            <option value="meta-llama/llama-3.1-70b-instruct">ðŸ¦™ Llama 3.1 70B (Open Source)</option>
                        </select>
                    </div>

                    <button type="submit" id="generateBtn"
                        class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-lg font-semibold hover:shadow-xl transition transform hover:scale-105 flex items-center justify-center space-x-2">
                        <i class="fas fa-magic"></i>
                        <span>Generate with Real AI</span>
                    </button>
                </form>
            </div>

            <!-- Preview -->
            <div class="bg-white rounded-xl shadow-xl p-8 border border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-file-medical-alt mr-2 text-indigo-600"></i>Prescription
                    </h2>
                    <span id="statusBadge" class="hidden px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-semibold">
                        <i class="fas fa-check-circle mr-1"></i>Generated
                    </span>
                </div>
                
                <div id="preview" class="border-2 border-dashed border-gray-300 rounded-lg p-8 min-h-[500px]">
                    <div class="text-center text-gray-400">
                        <i class="fas fa-file-medical text-6xl mb-4"></i>
                        <p class="text-lg font-semibold">Ready to Generate!</p>
                        <p class="text-sm mt-2">Choose AI model and fill the form</p>
                        <p class="text-xs mt-4 text-green-600">âœ… All 4 AI models are ready</p>
                    </div>
                </div>

                <div id="actionButtons" class="hidden mt-6 grid grid-cols-2 gap-4">
                    <button onclick="downloadPDF()" class="bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition flex items-center justify-center space-x-2">
                        <i class="fas fa-download"></i>
                        <span>Download PDF</span>
                    </button>
                    <button onclick="savePrescription()" class="bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center space-x-2">
                        <i class="fas fa-save"></i>
                        <span>Save to DB</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-xl p-8 max-w-4xl w-full mx-4 my-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Prescription History</h3>
                <button onclick="closeHistory()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div id="historyContent" class="space-y-4 max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // Pre-configured OpenRouter API key
        const OPENROUTER_API_KEY = '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';

        // LocalStorage Database
        class PrescriptionDB {
            constructor() {
                this.prescriptions = JSON.parse(localStorage.getItem('prescriptions') || '[]');
                this.patients = JSON.parse(localStorage.getItem('patients') || '[]');
            }

            savePrescription(data) {
                const prescription = {
                    id: Date.now(),
                    ...data,
                    createdAt: new Date().toISOString()
                };
                this.prescriptions.push(prescription);
                localStorage.setItem('prescriptions', JSON.stringify(this.prescriptions));
                
                if (!this.patients.find(p => p.name === data.patientName)) {
                    this.patients.push({
                        name: data.patientName,
                        age: data.age,
                        gender: data.gender
                    });
                    localStorage.setItem('patients', JSON.stringify(this.patients));
                }
                
                this.updateStats();
                return prescription;
            }

            getPrescriptions() {
                return this.prescriptions;
            }

            updateStats() {
                document.getElementById('totalPrescriptions').textContent = this.prescriptions.length;
                document.getElementById('totalPatients').textContent = this.patients.length;
                document.getElementById('historyCount').textContent = this.prescriptions.length;
            }
        }

        const db = new PrescriptionDB();
        let currentPrescription = null;

        // Initialize
        db.updateStats();

        // OpenRouter AI Integration
        async function generateWithAI(symptoms, age, gender, model) {
            const prompt = `You are an expert medical AI doctor. Generate a detailed prescription for:

Patient Age: ${age} years
Gender: ${gender}
Symptoms: ${symptoms}

Provide a complete prescription with:
1. Clear diagnosis based on symptoms
2. List of medicines with exact names, dosages, frequency, and duration
3. Important notes for each medicine
4. General health advice

Format your response as JSON:
{
  "diagnosis": "detailed diagnosis here",
  "medicines": [
    {
      "name": "Medicine name with strength (e.g., Paracetamol 500mg)",
      "dosage": "exact dosage and frequency (e.g., 1 tablet three times daily after meals)",
      "duration": "how many days (e.g., 5 days)",
      "notes": "important notes (e.g., Take with water, may cause drowsiness)"
    }
  ],
  "advice": ["advice 1", "advice 2", "advice 3"]
}`;

            try {
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'AI Prescription Pro'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert medical AI assistant. Always respond with valid JSON.'
                            },
                            {
                                role: 'user',
                                content: prompt
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 2000
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('API Error:', errorData);
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                const content = data.choices[0].message.content;
                
                // Extract JSON from response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    return JSON.parse(jsonMatch[0]);
                }
                
                return JSON.parse(content);
            } catch (error) {
                console.error('AI Error:', error);
                alert('AI generation failed: ' + error.message + '\n\nUsing fallback mode...');
                return generateFallback(symptoms, age);
            }
        }

        // Fallback generation
        function generateFallback(symptoms, age) {
            const lower = symptoms.toLowerCase();
            const medicines = [];
            
            if (lower.includes('fever')) {
                medicines.push({
                    name: 'Tab. Paracetamol 500mg',
                    dosage: '1 tablet three times daily after meals',
                    duration: '3-5 days',
                    notes: 'Take with plenty of water'
                });
            }
            
            if (lower.includes('cough')) {
                medicines.push({
                    name: 'Tab. Cetirizine 10mg',
                    dosage: '1 tablet once daily at bedtime',
                    duration: '5-7 days',
                    notes: 'May cause drowsiness'
                });
            }
            
            if (lower.includes('headache') || lower.includes('pain')) {
                medicines.push({
                    name: 'Tab. Ibuprofen 400mg',
                    dosage: '1 tablet when needed',
                    duration: 'as needed',
                    notes: 'Maximum 3 per day, take after meals'
                });
            }
            
            if (medicines.length === 0) {
                medicines.push({
                    name: 'Tab. Multivitamin',
                    dosage: '1 tablet daily after breakfast',
                    duration: '30 days',
                    notes: 'General health supplement'
                });
            }
            
            return {
                diagnosis: symptoms + ' (Fallback mode)',
                medicines: medicines,
                advice: [
                    'Adequate rest (7-8 hours sleep)',
                    'Drink plenty of water (8-10 glasses/day)',
                    'Avoid cold beverages',
                    'Follow up if symptoms persist'
                ]
            };
        }

        // Form submission
        document.getElementById('prescriptionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('patientName').value;
            const age = document.getElementById('patientAge').value;
            const gender = document.getElementById('gender').value;
            const symptoms = document.getElementById('symptoms').value;
            const model = document.getElementById('aiModel').value;
            
            const btn = document.getElementById('generateBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>AI Analyzing...';
            
            document.getElementById('preview').innerHTML = `
                <div class="text-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-indigo-600 mx-auto mb-4"></div>
                    <p class="text-indigo-600 font-semibold text-lg">Real AI is analyzing...</p>
                    <p class="text-gray-500 text-sm mt-2">Using ${model.split('/')[1]}</p>
                    <p class="text-xs text-gray-400 mt-4">This may take 5-15 seconds</p>
                </div>
            `;
            
            const aiResult = await generateWithAI(symptoms, age, gender, model);
            
            if (aiResult) {
                currentPrescription = {
                    patientName: name,
                    age: age,
                    gender: gender,
                    symptoms: symptoms,
                    model: model,
                    ...aiResult
                };
                
                displayPrescription(currentPrescription);
                document.getElementById('statusBadge').classList.remove('hidden');
                document.getElementById('actionButtons').classList.remove('hidden');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic mr-2"></i>Generate with Real AI';
        });

        function displayPrescription(data) {
            const date = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const modelName = data.model.split('/')[1];
            
            document.getElementById('preview').innerHTML = `
                <div class="space-y-6">
                    <div class="border-b-2 border-indigo-600 pb-4">
                        <h3 class="text-2xl font-bold text-indigo-600">Dr. Kumar Vaibhav</h3>
                        <p class="text-sm text-gray-600">MBBS, MD (Internal Medicine)</p>
                        <p class="text-xs text-gray-500 mt-1">AI-Powered by ${modelName}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3 text-sm bg-gray-50 p-4 rounded-lg">
                        <div><strong>Patient:</strong> ${data.patientName}</div>
                        <div><strong>Age/Gender:</strong> ${data.age} / ${data.gender}</div>
                        <div><strong>Date:</strong> ${date}</div>
                        <div><strong>AI Model:</strong> ${modelName}</div>
                    </div>
                    
                    <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-600">
                        <h4 class="font-bold text-blue-900 mb-2"><i class="fas fa-stethoscope mr-2"></i>Diagnosis:</h4>
                        <p class="text-sm text-blue-800">${data.diagnosis}</p>
                    </div>
                    
                    <div>
                        <h4 class="font-bold text-gray-900 mb-3"><i class="fas fa-pills mr-2 text-indigo-600"></i>Prescription:</h4>
                        <div class="space-y-3">
                            ${data.medicines.map((med, idx) => `
                                <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 rounded-lg border border-indigo-200">
                                    <div class="flex items-start">
                                        <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold mr-3 mt-1">${idx + 1}</span>
                                        <div class="flex-1">
                                            <p class="font-semibold text-gray-900">${med.name}</p>
                                            <p class="text-sm text-gray-700 mt-1">${med.dosage}${med.duration ? ' for ' + med.duration : ''}</p>
                                            ${med.notes ? `<p class="text-xs text-gray-600 mt-1 italic">${med.notes}</p>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${data.advice ? `
                    <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-600">
                        <h4 class="font-bold text-green-900 mb-2"><i class="fas fa-info-circle mr-2"></i>General Advice:</h4>
                        <ul class="text-sm text-green-800 space-y-1">
                            ${data.advice.map(a => `<li>â€¢ ${a}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}
                    
                    <div class="border-t pt-4 text-xs text-gray-500">
                        <p><i class="fas fa-check-circle text-green-600 mr-1"></i> Generated by ${modelName} AI</p>
                        <p><i class="fas fa-check-circle text-green-600 mr-1"></i> Saved in LocalStorage Database</p>
                    </div>
                </div>
            `;
        }

        function savePrescription() {
            if (currentPrescription) {
                db.savePrescription(currentPrescription);
                alert('âœ… Prescription saved to local database!');
            }
        }

        function downloadPDF() {
            if (!currentPrescription) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('AI PRESCRIPTION', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text('Dr. Kumar Vaibhav', 20, 40);
            doc.text('MBBS, MD (Internal Medicine)', 20, 47);
            
            doc.setFontSize(10);
            doc.text(`Patient: ${currentPrescription.patientName}`, 20, 60);
            doc.text(`Age: ${currentPrescription.age} | Gender: ${currentPrescription.gender}`, 20, 67);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 74);
            
            doc.text('Diagnosis:', 20, 87);
            const diagnosisLines = doc.splitTextToSize(currentPrescription.diagnosis, 170);
            doc.text(diagnosisLines, 20, 94);
            
            let y = 94 + (diagnosisLines.length * 7) + 10;
            doc.text('Prescription:', 20, y);
            y += 7;
            
            currentPrescription.medicines.forEach((med, idx) => {
                doc.text(`${idx + 1}. ${med.name}`, 20, y);
                y += 7;
                doc.text(`   ${med.dosage}${med.duration ? ' for ' + med.duration : ''}`, 20, y);
                y += 7;
                if (med.notes) {
                    const noteLines = doc.splitTextToSize(`   Note: ${med.notes}`, 170);
                    doc.text(noteLines, 20, y);
                    y += noteLines.length * 7;
                }
                y += 3;
            });
            
            doc.setFontSize(8);
            doc.text(`Generated by ${currentPrescription.model.split('/')[1]} AI â€¢ AI Prescription Pro`, 20, 280);
            
            doc.save(`prescription-${currentPrescription.patientName}-${Date.now()}.pdf`);
        }

        function showHistory() {
            const prescriptions = db.getPrescriptions();
            const content = document.getElementById('historyContent');
            
            if (prescriptions.length === 0) {
                content.innerHTML = '<p class="text-gray-500 text-center py-8">No prescriptions yet. Generate your first one!</p>';
            } else {
                content.innerHTML = prescriptions.reverse().map(p => `
                    <div class="bg-gray-50 p-4 rounded-lg border hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-lg">${p.patientName}</p>
                                <p class="text-sm text-gray-600">${p.age} years â€¢ ${p.gender}</p>
                                <p class="text-xs text-gray-500 mt-1">${new Date(p.createdAt).toLocaleString()}</p>
                            </div>
                            <span class="text-xs bg-purple-100 text-purple-700 px-3 py-1 rounded-full font-semibold">${p.model ? p.model.split('/')[1] : 'AI'}</span>
                        </div>
                        <p class="text-sm mt-3 text-gray-700 bg-white p-2 rounded">${p.diagnosis}</p>
                        <p class="text-xs text-gray-500 mt-2">${p.medicines.length} medicine(s) prescribed</p>
                    </div>
                `).join('');
            }
            
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function closeHistory() {
            document.getElementById('historyModal').classList.add('hidden');
        }
    </script>
</body>
</html>